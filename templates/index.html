<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BidSense Opportunities</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        h1 { margin-bottom: 0; }
        .score { font-weight: bold; }
        .high { color: green; }
        .medium { color: orange; }
        .low { color: red; }
        a.btn { display: inline-block; margin: 10px 5px 0 0; padding: 6px 12px; background: #007bff; color: white; text-decoration: none; border-radius: 4px; }
        a.btn:hover { background: #0056b3; }
        .filters { margin-top: 15px; }
        .filters a { margin-right: 10px; padding: 6px 12px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px; }
        .filters a.active { background: #007bff; }
        .filters a:hover { background: #5a6268; }
        .banner { padding: 10px; color: white; font-weight: bold; margin-top: 10px; border-radius: 5px; }
        .banner.training { background: orange; }
        .banner.auto { background: green; }
        .modal { display: none; position: fixed; z-index: 1000; padding-top: 60px; left: 0; top: 0; width: 100%; height: 100%; overflow: auto;
                 background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fff; margin: auto; padding: 20px; border: 1px solid #888; width: 70%; border-radius: 6px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
    </style>
</head>
<body>
    <h1>BidSense Opportunities</h1>

    <a href="{{ url_for('upload_rfp') }}" class="btn" style="background:#28a745;">üì§ Upload RFP</a>
    <a href="{{ url_for('toggle_mode') }}" class="btn" 
       style="background: {{ 'orange' if session.get('training_mode', True) else 'green' }};">
       {{ 'Switch to Auto Mode' if session.get('training_mode', True) else 'Switch to Training Mode' }}
    </a>

    <!-- Mode Banner -->
    {% if session.get('training_mode', True) %}
        <div class="banner training">‚ö† Training Mode Active ‚Äî RFPs require human review</div>
    {% else %}
        <div class="banner auto">‚úÖ Auto Mode Active ‚Äî RFPs are ingested automatically</div>
    {% endif %}

    <!-- Filter Bar -->
    <div class="filters">
        <a href="{{ url_for('index') }}"{% if not request.args.get('status') %} class="active"{% endif %}>All</a>
        <a href="{{ url_for('index', status='Open') }}"{% if request.args.get('status') == 'Open' %} class="active"{% endif %}>Open</a>
        <a href="{{ url_for('index', status='Won') }}"{% if request.args.get('status') == 'Won' %} class="active"{% endif %}>Won</a>
        <a href="{{ url_for('index', status='Closed') }}"{% if request.args.get('status') == 'Closed' %} class="active"{% endif %}>Closed</a>
        <a href="{{ url_for('index', status='Lost') }}"{% if request.args.get('status') == 'Lost' %} class="active"{% endif %}>Lost</a>
    </div>

    <table>
        <tr>
            <th>Title</th>
            <th>Agency</th>
            <th>Due Date</th>
            <th>Category</th>
            <th>Scope (snippet)</th>
            <th>Score</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
        {% for opp in opportunities %}
        <tr>
            <td>{{ opp['title'] }}</td>
            <td>{{ opp['agency'] }}</td>
            <td>{{ opp['due_date'] }}</td>
            <td>{{ opp['category'] }}</td>
            <td>
                {% if opp['scope_summary'] %}
                    {{ opp['scope_summary'][:80] }}{% if opp['scope_summary']|length > 80 %}...{% endif %}
                {% else %}
                    -
                {% endif %}
            </td>
            <td class="score
                {% if opp['score'] and opp['score']|int >= 70 %}high
                {% elif opp['score'] and opp['score']|int >= 40 %}medium
                {% else %}low{% endif %}">
                {{ opp['score'] if opp['score'] else '-' }}
            </td>
            <td>{{ opp['status'] }}</td>
            <td>
                <button onclick="openModal({{ opp['id'] }})">üîé Details</button>
                {% if opp['url'] %}
                    <a href="{{ opp['url'] }}" target="_blank">üîó Link</a>
                {% endif %}
                <a href="{{ url_for('update_status', opp_id=opp['id'], status='Won') }}">‚úÖ Won</a>
                <a href="{{ url_for('update_status', opp_id=opp['id'], status='Lost') }}">‚ùå Lost</a>
                <a href="{{ url_for('update_status', opp_id=opp['id'], status='Open') }}">üîÑ Reopen</a>
                <a href="{{ url_for('delete_opportunity', opp_id=opp['id']) }}" onclick="return confirm('Delete this opportunity?')">üóë Delete</a>
            </td>
        </tr>

        <!-- Modal for Details -->
        <div id="modal{{ opp['id'] }}" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal({{ opp['id'] }})">&times;</span>
                <h2>{{ opp['title'] }}</h2>
                <p><b>Agency:</b> {{ opp['agency'] }}</p>
                <p><b>Source:</b> {{ opp['source'] }}</p>
                <p><b>Issue Date:</b> {{ opp['issue_date'] }}</p>
                <p><b>Due Date:</b> {{ opp['due_date'] }}</p>
                <p><b>Category:</b> {{ opp['category'] }}</p>
                <p><b>Submission Method:</b> {{ opp['submission_method'] }}</p>
                <p><b>Pre-Bid:</b> {{ opp['prebid'] }} ({{ opp['prebid_required'] }})</p>
                <p><b>Q&A Deadline:</b> {{ opp['qna_deadline'] }}</p>
                <p><b>Set-Aside:</b> {{ opp['set_aside'] }}</p>
                <p><b>Bonding:</b> {{ opp['bonding'] }}</p>
                <p><b>Insurance:</b> {{ opp['insurance'] }}</p>
                <p><b>Contacts:</b> {{ opp['contacts'] }}</p>
                <p><b>Scope Summary:</b> {{ opp['scope_summary'] }}</p>
                <p><b>Tech Requirements:</b> {{ opp['tech_requirements'] }}</p>
            </div>
        </div>
        {% endfor %}
    </table>

    <script>
        function openModal(id) {
            document.getElementById("modal" + id).style.display = "block";
        }
        function closeModal(id) {
            document.getElementById("modal" + id).style.display = "none";
        }
        window.onclick = function(event) {
            var modals = document.getElementsByClassName("modal");
            for (var i = 0; i < modals.length; i++) {
                if (event.target == modals[i]) {
                    modals[i].style.display = "none";
                }
            }
        }
    </script>
</body>
</html>

