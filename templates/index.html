<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>BidSense ‚Äì Opportunities</title>
  <style>
    body { font-family: system-ui, Arial; margin: 20px; background:#f8f9fa; }
    h1 { margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; background:#fff; }
    th, td { border-bottom: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background:#f1f3f5; text-align:left; }
    .actions a { margin-right: 8px; font-size:13px; }
    .badge { padding: 2px 8px; border-radius: 6px; font-size: 12px; display:inline-block; }
    .open { background: #e7f7ee; }
    .approved { background:#e8f0ff; }
    .won { background: #e6ffe9; }
    .lost { background: #ffe9e9; }
    .banner { padding:10px 14px; border-radius:8px; display:inline-block; margin-bottom:12px; font-weight:600; }
    .training { background:#fff3cd; }
    .auto { background:#d4edda; }
    .btn { display:inline-block; padding:6px 12px; border-radius:4px; text-decoration:none; font-size:14px; }
    .btn-upload { background:#28a745; color:#fff; }
    .btn-toggle { background:#007bff; color:#fff; margin-left:10px; }
    a { color:#1a73e8; }
    .just-updated { background: #fff3cd !important; transition: background 0.8s; }
  </style>
</head>
<body>
  <h1>BidSense Opportunities</h1>

  <div class="banner {{ 'training' if training_mode else 'auto' }}">
    {{ 'Training Mode Active ‚Äî RFPs require human review' if training_mode else 'Auto Mode Active ‚Äî RFPs are ingested automatically' }}
  </div>
  <br>
  <a href="{{ url_for('upload_rfp') }}" class="btn btn-upload">üì§ Upload RFP</a>
  <a href="{{ url_for('toggle_mode') }}" class="btn btn-toggle">
    {{ 'Switch to Auto Mode' if training_mode else 'Switch to Training Mode' }}
  </a>

  <p>Filter:
    <a href="{{ url_for('index') }}">All</a> |
    <a href="{{ url_for('index', status='Open') }}">Open</a> |
    <a href="{{ url_for('index', status='Approved') }}">Approved</a> |
    <a href="{{ url_for('index', status='Won') }}">Won</a> |
    <a href="{{ url_for('index', status='Lost') }}">Lost</a>
  </p>

  <table>
    <thead>
      <tr>
        <th>Title / Agency</th>
        <th>Due / Q&A / Pre-Bid</th>
        <th>Category / Submission</th>
        <th>Scope (snippet)</th>
        <th>Score</th>
        <th>Status & Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for o in opportunities %}
      <tr id="row-{{ o['id'] }}">
        <td>
          <strong><a href="{{ url_for('opportunity_detail', opp_id=o['id']) }}">{{ o['title'] or '‚Äî' }}</a></strong><br>
          {{ o['agency'] or '‚Äî' }}<br>
          <small>ID: {{ o['external_id'] or '‚Äî' }}</small>
        </td>
        <td>
          <div><strong>Due:</strong> {{ o['due_date'] or '‚Äî' }}</div>
          <div><strong>Q&A:</strong> {{ o['qna_deadline'] or '‚Äî' }}</div>
          <div><strong>Pre-Bid:</strong> {{ o['prebid'] or '‚Äî' }} {% if o['prebid_required'] %} ({{ o['prebid_required'] }}){% endif %}</div>
        </td>
        <td>
          <div><strong>{{ o['category'] or '‚Äî' }}</strong></div>
          <div><strong>Submit:</strong> {{ o['submission_method'] or '‚Äî' }}</div>
          <div><small>Set-aside: {{ o['set_aside'] or '‚Äî' }}</small></div>
        </td>
        <td>
          {% set scope = (o['scope_summary'] or '') %}
          {{ scope[:120] }}{% if scope|length > 120 %}‚Ä¶{% endif %}
        </td>
        <td>{{ o['score'] if o['score'] is not none else '‚Äî' }}</td>
        <td class="actions">
          {% set st = (o['status'] or 'Open') %}
          <span class="badge {{ 'approved' if st=='Approved' else ('open' if st=='Open' else ('won' if st=='Won' else 'lost')) }}">{{ st }}</span><br>
          <a href="{{ url_for('opportunity_detail', opp_id=o['id']) }}">üìÅ Details</a>
          <a href="{{ url_for('update_status', opp_id=o['id'], status='Approved') }}">‚úÖ Approve</a>
          <a href="{{ url_for('update_status', opp_id=o['id'], status='Won') }}">üèÅ Won</a>
          <a href="{{ url_for('update_status', opp_id=o['id'], status='Lost') }}">‚ùå Lost</a>
          <a href="{{ url_for('update_status', opp_id=o['id'], status='Open') }}">üîÑ Reopen</a>
          <a href="{{ url_for('delete_opportunity', opp_id=o['id']) }}" onclick="return confirm('Delete this record?')">üóë Delete</a>
        </td>
      </tr>
      {% else %}
      <tr><td colspan="6">No opportunities yet. Upload one!</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    (function () {
      if (location.hash) {
        var el = document.querySelector(location.hash);
        if (el) {
          el.scrollIntoView({ block: "center" });
          el.classList.add("just-updated");
          setTimeout(function(){ el.classList.remove("just-updated"); }, 1600);
        }
      }
    })();
  </script>
</body>
</html>
